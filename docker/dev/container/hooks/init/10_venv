#!/bin/bash

set -euo pipefail
LOCKDIR=/opt/pycroft/venv
INFILE=uv.lock
STAMPFILE=.uv.stamp

. /container/common/locking.sh

function execute_hook() {
  set -x
  PIP="uv pip"

  if [[ ! $INFILE -nt $STAMPFILE ]]; then
    echo "Lockfile did not change since last run. Nothing to do."
    return
  fi

  echo "No pip packages found, installing requirements"
  cd /opt/pycroft/app
  ls $(uv cache dir)
  uv sync --locked
  $PIP install -e '.[dev]' -e './deps/wtforms-widgets'
  touch $STAMPFILE
}

[[ -d $LOCKDIR ]] || mkdir $LOCKDIR
execute_with_dirlock $LOCKDIR execute_hook
